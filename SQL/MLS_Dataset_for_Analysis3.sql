WITH properties_with_changes AS (
  SELECT
    CC_PROPERTY_ID,
    MIN(RECORD_DATE_TIME) AS first_date,
    MAX(RECORD_DATE_TIME) AS last_date,
    MIN(BEDROOMS) AS min_beds,
    MAX(BEDROOMS) AS max_beds,
    MIN(FULL_BATHS) AS min_baths,
    MAX(FULL_BATHS) AS max_baths,
    COUNT(DISTINCT RECORD_DATE_TIME) AS num_snapshots
  FROM ROC_MLS_DATA.ATTOM.MLS
  WHERE RECORD_DATE_TIME >= '2018-01-01'
    AND BEDROOMS IS NOT NULL
    AND FULL_BATHS IS NOT NULL
  GROUP BY CC_PROPERTY_ID
  HAVING MAX(BEDROOMS) > MIN(BEDROOMS) OR MAX(FULL_BATHS) > MIN(FULL_BATHS)
),

ny_properties AS (
  SELECT
    PROPERTYID,
    SITUSSTATE,
    SITUSCITY,
    SITUSZIP5,
    ROW_NUMBER() OVER (PARTITION BY PROPERTYID ORDER BY MARKETYEAR DESC) AS rn
  FROM ROC_PUBLIC_RECORD_DATA.DATATREE.ASSESSOR
  WHERE UPPER(SITUSSTATE) IN ('NY', 'NEW YORK')
    AND SITUSZIP5 NOT LIKE '100%'
    AND SITUSZIP5 NOT LIKE '101%'
    AND SITUSZIP5 NOT LIKE '102%'
    AND SITUSZIP5 NOT LIKE '103%'
    AND SITUSZIP5 NOT LIKE '104%'
    AND SITUSZIP5 NOT LIKE '112%'
    AND SITUSZIP5 NOT LIKE '113%'
    AND SITUSZIP5 NOT LIKE '114%'
    AND SITUSZIP5 NOT LIKE '116%'
)

SELECT
  mls.CC_PROPERTY_ID,
  mls.RECORD_DATE_TIME,

  -- PROPERTY FEATURES
  mls.BEDROOMS,
  mls.FULL_BATHS,
  mls.HALF_BATHS,
  mls.GLA_SQFT,
  mls.ROOMS,
  mls.GARAGE_SPACES,

  -- LOCATION
  ny.SITUSSTATE,
  ny.SITUSCITY,
  ny.SITUSZIP5,

  -- TREATMENT PERIOD CLASSIFICATION
  pwc.min_beds,
  pwc.max_beds,
  pwc.min_baths,
  pwc.max_baths,

  CASE
    WHEN mls.BEDROOMS = pwc.min_beds AND mls.FULL_BATHS = pwc.min_baths
    THEN 'PRE_TREATMENT'
    WHEN mls.BEDROOMS = pwc.max_beds AND mls.FULL_BATHS = pwc.max_baths
    THEN 'POST_TREATMENT'
    ELSE 'TRANSITION'
  END AS TREATMENT_PERIOD,

  'TREATED' AS PROPERTY_TYPE

FROM ROC_MLS_DATA.ATTOM.MLS mls
INNER JOIN properties_with_changes pwc
  ON mls.CC_PROPERTY_ID = pwc.CC_PROPERTY_ID
INNER JOIN ny_properties ny
  ON mls.CC_PROPERTY_ID = ny.PROPERTYID
  AND ny.rn = 1

WHERE mls.RECORD_DATE_TIME BETWEEN pwc.first_date AND pwc.last_date

ORDER BY mls.CC_PROPERTY_ID, mls.RECORD_DATE_TIME
LIMIT 5000;